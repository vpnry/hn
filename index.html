<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta name="theme-color" content="#ff6600"> -->
    <title>HN Reader</title>
    <style>
        /* Base reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Theme variables */
        :root {
            --bg: #f6f6ef;
            --panel-bg: #ffffff;
            --text: #000000;
            --muted: #666666;
            --accent: #ff6600;
            --border: #f0f0f0;
            --header-bg: var(--accent);
            --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
            --date-bg: #fff5eb;
            --error-bg: #fff0f0;
            --error-border: #ffcccc;
            --loading-spinner-bg: #f3f3f3;
            --loading-spinner-top: var(--accent);
            --nav-link-color: #fff;
            --base-font-size: 14px;
        }

        /* Professional dark theme */
        .dark {
            --bg: #0b0f12;
            --panel-bg: #0f1720;
            --text: #e6eef6;
            --muted: #9aa6b2;
            --accent: #ff8a3d;
            --border: #1e2a33;
            --header-bg: linear-gradient(90deg, #ff8a3d, #ff6a00);
            --card-shadow: none;
            --date-bg: rgba(255,138,61,0.06);
            --error-bg: #2a1313;
            --error-border: #5b1e1e;
            --loading-spinner-bg: #12202a;
            --loading-spinner-top: var(--accent);
            --nav-link-color: rgba(255,255,255,0.95);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: var(--base-font-size);
        }

        .header {
            background: var(--header-bg);
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--card-shadow);
        }

        .logo {
            font-weight: bold;
            color: white;
            font-size: calc(var(--base-font-size) + 4px);
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 15px;
            flex: 1;
        }

        .nav a, .nav button {
            color: var(--nav-link-color);
            text-decoration: none;
            font-size: var(--base-font-size);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .nav a:hover, .nav button:hover {
            background: rgba(255,255,255,0.08);
        }

        .nav a.active {
            background: rgba(255,255,255,0.12);
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .time-filter {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: calc(var(--base-font-size) - 1px);
            cursor: pointer;
            color: var(--text);
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid transparent;
            padding: 6px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--nav-link-color);
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.06);
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .story-list {
            background: var(--panel-bg);
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
        }

        .story {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 15px;
            transition: background 0.2s;
        }

        .story:hover {
            background: rgba(255,255,255,0.02);
        }

        .story:last-child {
            border-bottom: none;
        }

        .rank {
            color: var(--muted);
            font-size: var(--base-font-size);
            min-width: 30px;
            text-align: right;
        }

        .left-stats {
            width: 64px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            font-size: calc(var(--base-font-size) - 1px);
            color: var(--muted);
            min-width: 64px;
        }

        .left-stats .comments {
            font-weight: 600;
            color: var(--text);
            font-size: calc(var(--base-font-size) + 1px);
        }

        .left-stats .points {
            color: var(--accent);
            font-weight: 700;
            font-size: calc(var(--base-font-size) - 1px);
        }

        .content {
            flex: 1;
        }

        .title-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 6px;
        }

        .title {
            font-size: calc(var(--base-font-size) + 2px);
            font-weight: 500;
            color: var(--text);
            text-decoration: none;
        }

        .title:hover {
            color: var(--accent);
        }

        .title:visited {
            color: #9aa6b2;
        }

        .domain {
            color: var(--muted);
            font-size: calc(var(--base-font-size) - 2px);
        }

        .meta {
            display: flex;
            gap: 12px;
            font-size: calc(var(--base-font-size) - 1px);
            color: var(--muted);
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta a {
            color: var(--muted);
            text-decoration: none;
        }

        .meta a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .points {
            color: var(--accent);
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .spinner {
            border: 3px solid var(--loading-spinner-bg);
            border-top: 3px solid var(--loading-spinner-top);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: #ffb3a3;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .filters {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .date-header {
            background: var(--date-bg); /* pale orange / subtle */
            padding: 8px 12px;
            font-weight: 700;
            color: var(--accent);
            border-radius: 6px 6px 0 0;
            margin-top: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-separator {
            height: 1px;
            background: var(--border);
            margin: 8px 0 16px 0;
            border-radius: 1px;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-group label {
            font-size: calc(var(--base-font-size) - 1px);
            color: var(--muted);
            font-weight: 500;
        }

        .filter-group select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: calc(var(--base-font-size) - 1px);
            background: var(--panel-bg);
            color: var(--text);
            cursor: pointer;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 2px;
        }

        .font-button {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 3px;
        }

        .font-button:hover {
            background: var(--border);
        }

        .font-size-display {
            font-size: calc(var(--base-font-size) - 1px);
            color: var(--text);
            padding: 0 5px;
            min-width: 40px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .nav {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
                width: 100%;
                border-top: 1px solid rgba(255,255,255,0.1);
                padding-top: 10px;
            }

            .controls {
                width: 100%;
                justify-content: space-between;
            }

            .container {
                margin-top: 15px;
                padding: 0 10px;
            }

            .story {
                flex-direction: column;
                gap: 10px;
            }

            .left-stats {
                flex-direction: row;
                width: auto;
                gap: 15px;
                align-items: baseline;
            }

            .rank {
                display: none; /* Hide rank on mobile to save space */
            }

            .title-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }

            .title {
                font-size: calc(var(--base-font-size) + 1px);
            }

            .meta {
                font-size: calc(var(--base-font-size) - 2px);
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="#" class="logo" onclick="loadStories('top', 1); return false;">HN Reader</a>
        <div class="controls">
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle dark / light">
                <!-- Sun / Moon icon (will be swapped by CSS/JS) -->
                <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
                </svg>
            </button>
            <div class="font-size-control">
                <button id="decreaseFont" class="font-button" title="Decrease font size">-</button>
                <span id="fontSizeDisplay" class="font-size-display">14px</span>
                <button id="increaseFont" class="font-button" title="Increase font size">+</button>
            </div>
            <select class="time-filter" onchange="handleTimeFilter(this.value)">
                <option value="all">All Time</option>
                <option value="24">Last 24h</option>
                <option value="168">Past Week</option>
                <option value="720">Past Month</option>
            </select>
        </div>
        <nav class="nav">
            <a href="#" onclick="loadStories('top', 1); return false;" class="active" data-section="top">Top</a>
            <a href="#" onclick="loadStories('new', 1); return false;" data-section="new">New</a>
            <a href="#" onclick="loadStories('best', 1); return false;" data-section="best">Best</a>
            <a href="#" onclick="loadStories('ask', 1); return false;" data-section="ask">Ask</a>
            <a href="#" onclick="loadStories('show', 1); return false;" data-section="show">Show</a>
            <a href="#" onclick="loadStories('job', 1); return false;" data-section="job">Jobs</a>
        </nav>

    </div>

    <div class="container">
        <div class="filters">
            <div class="filter-group">
                <label>Min Points:</label>
                <select id="minPoints" onchange="applyFilters()">
                    <option value="0">Any</option>
                    <option value="10">10+</option>
                    <option value="50">50+</option>
                    <option value="100">100+</option>
                    <option value="200">200+</option>
                    <option value="500">500+</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Min Comments:</label>
                <select id="minComments" onchange="applyFilters()">
                    <option value="0">Any</option>
                    <option value="5">5+</option>
                    <option value="10">10+</option>
                    <option value="25">25+</option>
                    <option value="50">50+</option>
                    <option value="100">100+</option>
                </select>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading stories...</p>
            </div>
        </div>

        <div id="loader" class="loading" style="display: none;">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://hn.algolia.com/api/v1/search_by_date';
        const content = document.getElementById('content');
        const loader = document.getElementById('loader');

        let isLoading = false;
        let currentSection = 'top';
        let lastLoadedDate = null;
        let storyCount = 0;

        // --- Settings and State Management ---

        function getSettings() {
            const defaults = {
                section: 'top',
                time: 'all',
                minPoints: '100',
                minComments: '0',
            };
            const settings = {
                section: localStorage.getItem('hnr-section') || defaults.section,
                time: localStorage.getItem('hnr-time') || defaults.time,
                minPoints: localStorage.getItem('hnr-minPoints') || defaults.minPoints,
                minComments: localStorage.getItem('hnr-minComments') || defaults.minComments,
            };
            return settings;
        }

        function saveSettings() {
            localStorage.setItem('hnr-section', currentSection);
            localStorage.setItem('hnr-time', document.querySelector('.time-filter').value);
            localStorage.setItem('hnr-minPoints', document.getElementById('minPoints').value);
            localStorage.setItem('hnr-minComments', document.getElementById('minComments').value);
            // persist theme choice if present
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('hnr-theme', theme);
        }

        function applySettings() {
            const settings = getSettings();
            currentSection = settings.section;
            document.querySelector('.time-filter').value = settings.time;
            document.getElementById('minPoints').value = settings.minPoints;
            document.getElementById('minComments').value = settings.minComments;

            document.querySelectorAll('.nav a').forEach(a => {
                a.classList.toggle('active', a.dataset.section === currentSection);
            });
            // apply saved theme preference (or system preference)
            applySavedTheme();

            const savedFontSize = localStorage.getItem('hnr-fontSize') || '14';
            changeFontSize(parseInt(savedFontSize, 10));
        }

        // --- Theme management ---
        function getSavedTheme() {
            return localStorage.getItem('hnr-theme');
        }

        function applySavedTheme() {
            const saved = getSavedTheme();
            if (saved === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (saved === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                // no preference saved -> respect system preference
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) document.documentElement.classList.add('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('hnr-theme', theme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if (!icon) return;
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                // moon icon
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>';
            } else {
                // sun icon
                icon.innerHTML = '<path d="M6.76 4.84l-1.8-1.79L3.17 4.83l1.79 1.79 1.8-1.78zM1 13h3v-2H1v2zm10-9h2V1h-2v3zm7.66 1.05l-1.79 1.79 1.79 1.79 1.79-1.79-1.79-1.79zM20 11v2h3v-2h-3zM12 6a6 6 0 100 12 6 6 0 000-12zm0 10a4 4 0 110-8 4 4 0 010 8zm-6.36 4.95l1.79-1.79-1.79-1.79-1.79 1.79 1.79 1.79zM12 23h2v-3h-2v3z" fill="currentColor"/>';
            }
        }

        // --- API Fetching and Rendering ---

        async function fetchStoriesForDate(date) {
            isLoading = true;
            loader.style.display = 'block';

            const settings = getSettings();
            const tags = ['story'];
            if (['ask', 'show', 'job'].includes(currentSection)) {
                tags.push(`${currentSection}_hn`);
            }

            const minPoints = parseInt(settings.minPoints);
            const minComments = parseInt(settings.minComments);
            
            const now = date.getTime() / 1000;
            const startOfDay = new Date(date.setHours(0, 0, 0, 0)).getTime() / 1000;
            const endOfDay = new Date(date.setHours(23, 59, 59, 999)).getTime() / 1000;

            let numericFilters = [`created_at_i>=${startOfDay}`, `created_at_i<=${endOfDay}`];
            if (minPoints > 0) numericFilters.push(`points>=${minPoints}`);
            if (minComments > 0) numericFilters.push(`num_comments>=${minComments}`);

            const url = `${API_BASE_URL}?tags=(${tags.join(',')})&numericFilters=${numericFilters.join(',')}&hitsPerPage=100`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                let stories = data.hits.filter(h => h.title && h.url);
                
                // For 'top', we should sort by points. Algolia's default is recent.
                if (currentSection === 'top' || currentSection === 'best') {
                    stories.sort((a, b) => (b.points || 0) - (a.points || 0));
                }

                if (stories.length > 0) {
                    displayStories(stories, date);
                    storyCount += stories.length;
                } else {
                    displayNoStoriesMessage(date);
                }
                
                lastLoadedDate = new Date(date.getTime());
                lastLoadedDate.setDate(lastLoadedDate.getDate() - 1);

            } catch (error) {
                console.error('Failed to load stories:', error);
                content.innerHTML += '<div class="error">Failed to load stories. Please try again.</div>';
            } finally {
                isLoading = false;
                loader.style.display = 'none';
            }
        }

        function displayStories(stories, date) {
            const dateKey = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            
            let dateHeader = document.querySelector(`[data-date-key="${dateKey}"]`);
            if (!dateHeader) {
                const headerHtml = `<div class="date-header" data-date-key="${dateKey}">${dateKey}</div><div class="story-list" data-date-list="${dateKey}"></div>`;
                content.innerHTML += headerHtml;
            }

            const storyList = document.querySelector(`[data-date-list="${dateKey}"]`);
            
            const htmlParts = stories.map(story => {
                const url = story.url || `https://news.ycombinator.com/item?id=${story.objectID}`;
                const domain = story.url ? new URL(story.url).hostname.replace('www.', '') : 'news.ycombinator.com';
                const points = story.points || 0;
                const comments = story.num_comments || 0;
                const timeAgo = formatTimeAgo(story.created_at_i);

                return `
                    <div class="story">
                        <div class="left-stats">
                            <div class="comments">${comments}</div>
                            <div class="points">${points}</div>
                        </div>
                        <div class="content">
                            <div class="title-row">
                                <a href="${url}" class="title" target="_blank" rel="noopener">${story.title}</a>
                                <span class="domain">(${domain})</span>
                            </div>
                            <div class="meta">
                                <span class="meta-item">by <a href="https://news.ycombinator.com/user?id=${story.author}" target="_blank">${story.author}</a></span>
                                <span class="meta-item">${timeAgo}</span>
                                <span class="meta-item">
                                    <a href="https://news.ycombinator.com/item?id=${story.objectID}" target="_blank">discussion</a>
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            storyList.innerHTML += htmlParts.join('\n');
        }
        
        function displayNoStoriesMessage(date) {
            const dateKey = date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            content.innerHTML += `<div class="date-header date-header-empty">${dateKey}: No stories found matching your criteria.</div>`;
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor(Date.now() / 1000 - timestamp);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 2592000) return `${Math.floor(seconds / 86400)}d ago`;
            return new Date(timestamp * 1000).toLocaleDateString();
        }

        // --- Event Handlers ---

        function handleNavClick(section) {
            currentSection = section;
            document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            resetAndLoad();
        }

        function applyFilters() {
            resetAndLoad();
        }
        
        function handleTimeFilter(value) {
            // This function is kept for compatibility but infinite scroll overrides it.
            // For now, it just triggers a reload.
            resetAndLoad();
        }

        function resetAndLoad() {
            saveSettings();
            content.innerHTML = '';
            storyCount = 0;
            lastLoadedDate = new Date(); // Start from today
            fetchStoriesForDate(lastLoadedDate);
        }

        window.addEventListener('scroll', () => {
            if (isLoading) return;
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                if (lastLoadedDate) {
                    fetchStoriesForDate(lastLoadedDate);
                }
            }
        });

        // --- Initial Load ---
        
        document.addEventListener('DOMContentLoaded', () => {
            applySettings();
            resetAndLoad();
            
            // Attach event listeners
            document.querySelectorAll('.nav a').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleNavClick(a.dataset.section);
                });
            });
            // theme toggle handler
            const themeBtn = document.getElementById('themeToggle');
            if (themeBtn) {
                themeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleTheme();
                });
            }
            // ensure icon matches initial theme
            updateThemeIcon();

            document.getElementById('increaseFont').addEventListener('click', () => {
                let currentSize = parseInt(document.documentElement.style.getPropertyValue('--base-font-size')) || 14;
                changeFontSize(currentSize + 1);
            });

            document.getElementById('decreaseFont').addEventListener('click', () => {
                let currentSize = parseInt(document.documentElement.style.getPropertyValue('--base-font-size')) || 14;
                changeFontSize(currentSize - 1);
            });
        });

        function changeFontSize(size) {
            document.documentElement.style.setProperty('--base-font-size', `${size}px`);
            document.getElementById('fontSizeDisplay').textContent = `${size}px`;
            localStorage.setItem('hnr-fontSize', size);
        }

    </script>
</body>
</html>
